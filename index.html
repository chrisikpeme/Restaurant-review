<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Restaurant Review — Pro</title>
<style>
  :root{--bg:#0b1022;--card:#0f172a;--ink:#e6edf3;--mut:#9fb0c3;--line:#213047;--accent:#10b981;--chip:#0a1122}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
  h1{margin:0 0 6px;font-size:24px} h2{margin:18px 0 8px;font-size:16px;color:var(--mut)}
  label{display:block;margin:8px 0 4px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:var(--chip);color:var(--ink)}
  textarea{min-height:84px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .g12{grid-column:span 12}.g8{grid-column:span 8}.g6{grid-column:span 6}.g4{grid-column:span 4}.g3{grid-column:span 3}
  @media(max-width:860px){.g8,.g6,.g4,.g3{grid-column:span 12}}
  .chips{display:flex;flex-wrap:wrap;gap:6px}
  .chip{min-width:40px;text-align:center;padding:8px 0;border:1px solid var(--line);border-radius:10px;background:var(--chip);color:var(--ink);cursor:pointer;transition:.15s}
  .chip:hover{transform:translateY(-1px)}
  .chip[aria-pressed="true"]{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset;background:#0e1b16}
  .mut{color:var(--mut);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{border:1px solid var(--line);background:var(--chip);color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer}
  button.primary{border-color:var(--accent)}
  progress{width:100%;height:12px}
  pre{white-space:pre-wrap;background:#0a1122;border:1px solid var(--line);border-radius:10px;padding:10px;overflow:auto}
  details{margin-top:10px}
  details>summary{cursor:pointer;color:var(--mut)}
  .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);background:#0f1f16;border:1px solid #183f31;color:#c7ffdf;padding:10px 14px;border-radius:10px;opacity:0;transition:.2s}
  .toast.show{opacity:1}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Restaurant Review — <span class="mut">best-in-class scoring</span></h1>
    <div class="mut">Tap scores 0–10 for each category. Food is weighted most heavily (67%).</div>

    <div class="grid" style="margin-top:10px">
      <div class="g6"><label>Restaurant</label><input id="restaurant" placeholder="e.g., Test Bistro"></div>
      <div class="g3"><label>City</label><input id="city" placeholder="City"></div>
      <div class="g3"><label>Date</label><input id="date" type="date"></div>
      <div class="g6"><label>Reviewer</label><input id="reviewer" placeholder="Your name"></div>
      <div class="g6"><label>Notes</label><textarea id="notes" placeholder="Highlights, weaknesses, dishes to remember…"></textarea></div>
    </div>

    <h2>Categories</h2>
    <div id="cats"></div>

    <h2>Overall result</h2>
    <div class="grid">
      <div class="g8">
        <div class="row"><strong>Weighted Overall:</strong>
          <span id="overall" style="margin-left:6px">0.0</span> / 10 — <span id="band" class="mut">—</span>
        </div>
        <progress id="bar" max="10" value="0"></progress>
        <div class="mut">Banding: 9.5+ Elite · 8.5–9.4 Outstanding · 7.5–8.4 Excellent · 6.5–7.4 Good · else Mixed/below.</div>
      </div>
      <div class="g4">
        <div class="row">
          <button id="saveLocal">Save to browser</button>
          <button id="clearForm">Clear form</button>
          <button id="syncBtn" class="primary">Save + sync to Sheet</button>
        </div>
      </div>
    </div>

    <!-- Config & diagnostics (hidden unless ?debug=1) -->
    <div id="configBlock" style="display:none">
      <h2>Configuration</h2>
      <div class="grid">
        <div class="g8"><label>Sheet.best Endpoint URL</label><input id="endpoint"></div>
        <div class="g4"><label>API key (optional)</label><input id="apikey" placeholder="only if your connection requires it"></div>
      </div>
      <div class="row">
        <button id="saveCfg">Save config</button>
      </div>
      <details id="diag">
        <summary>Diagnostics (optional)</summary>
        <div class="row" style="margin-top:8px">
          <button id="testBtn">Test endpoint (GET)</button>
          <button id="postBtn">POST sample row</button>
        </div>
        <pre id="log">—</pre>
      </details>
      <div class="mut" style="margin-top:8px">
        Your Google Sheet must have headers in row 1: <code>Timestamp, Date, Restaurant, City, Reviewer, Food, Service, Ambience, Drinks, Value, Consistency, Overall, Band, Notes, UserAgent</code>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast">Synced!</div>

<script>
/* ======= FINAL SETTINGS ======= */
const DEFAULT_ENDPOINT = 'https://api.sheetbest.com/sheets/9707a268-edd0-4f09-afe3-3f430786e8e2';
const DEFAULT_APIKEY   = '';   // keep '' since your Sheet.best is "Use API = No"
/* ============================== */

const DEBUG = new URLSearchParams(location.search).get('debug') === '1';
const CATS = [
  {key:'Food', label:'Food · 67%', w:0.67, help:'Depth, clarity, seasoning, execution, balance'},
  {key:'Service', label:'Service · 10%', w:0.10, help:'Warmth, pace, accuracy, product knowledge'},
  {key:'Ambience', label:'Ambience · 7%', w:0.07, help:'Comfort, acoustics, lighting, character'},
  {key:'Drinks', label:'Drinks · 6%', w:0.06, help:'List breadth, curation, pricing, pairings'},
  {key:'Value', label:'Value · 5%', w:0.05, help:'Worth vs. experience and market peers'},
  {key:'Consistency', label:'Consistency · 5%', w:0.05, help:'Reliability across dishes/visits'}
];
// Per-score descriptors (original wording)
const DESCR = {
  Food: {10:"Benchmark cooking; flawless technique; vivid, memorable dishes.",9:"Refined and precise; deep flavor and balance; tiny quibbles only.",8:"Skilled cooking with character; consistent seasoning and texture.",7:"Solid with clear highlights; a few uneven elements.",6:"Competent but lacks spark or definition.",5:"Hit-and-miss; seasoning or textures off at times.",4:"Several technical slips; muddled flavors.",3:"Poor execution; weak balance and control.",2:"Major faults that distract from the dish.",1:"Serious issues; would not order again.",0:"Not served / unable to assess."},
  Service: {10:"Anticipatory and effortless; personal yet unobtrusive.",9:"Polished pacing and excellent product knowledge.",8:"Attentive and warm; minor slips only.",7:"Friendly, generally on time; a few gaps.",6:"Basic, reactive rather than proactive.",5:"Inconsistent; noticeable waits or misses.",4:"Disjointed; items forgotten or mixed up.",3:"Slow and inattentive throughout.",2:"Frequent errors; little course control.",1:"Unhelpful or dismissive.",0:"Not applicable."},
  Ambience: {10:"Distinctive, comfortable, and acoustically calm; lighting spot-on.",9:"Stylish and coherent; easy to relax.",8:"Pleasant space with thoughtful details.",7:"Comfortable, a touch generic.",6:"Functional but lacks character.",5:"Crowded/noisy or awkward layout at times.",4:"Lighting or acoustics regularly detract.",3:"Uncomfortable seating or distracting noise.",2:"Poorly maintained or harsh environment.",1:"Actively unpleasant.",0:"Not applicable."},
  Drinks: {10:"Deep, curated list; smart pairings; fair margins.",9:"Broad, well-priced selection; confident pairing.",8:"Good choice across styles; sensible pricing.",7:"Decent range; a few standouts.",6:"Limited but workable.",5:"Narrow list or uneven pricing.",4:"Short list and weak pairing options.",3:"Few appealing choices.",2:"Overpriced or consistently mismatched.",1:"Poor quality pours.",0:"Not applicable."},
  Value: {10:"Remarkable value relative to quality and peers.",9:"Well-priced for the experience delivered.",8:"Fair pricing; feels justified.",7:"Slightly above peers but acceptable.",6:"Noticeably priced up for what you get.",5:"Mixed value; some items overpriced.",4:"Regularly overpriced vs peers.",3:"Poor value across much of the menu.",2:"High prices with little return.",1:"Would not return at these prices.",0:"Not applicable."},
  Consistency: {10:"Rock-solid across dishes and visits.",9:"Minor variance only; highly dependable.",8:"Mostly steady with rare dips.",7:"Some swings between dishes or days.",6:"Uneven week to week.",5:"Hit-and-miss; depends on the order.",4:"Regular lapses in execution.",3:"Frequent inconsistency.",2:"Usually below its best.",1:"Rarely delivers as expected.",0:"Not applicable."}
};
const scores = {};
const cfgKey='sheetbest_cfg_v3';
function $(id){return document.getElementById(id);}
function log(msg){const el=$('log'); if(!el) return; el.textContent=(typeof msg==='string')?msg:JSON.stringify(msg,null,2);}
function toast(msg){const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600);}
function n(x){return Number(x)||0;}
function updateOverall(){
  let total=0; CATS.forEach(c=>{ total += n(scores[c.key])*c.w; });
  const o = Math.round(total*10)/10;
  $('overall').textContent=o.toFixed(1);
  $('bar').value=o;
  $('band').textContent =
    (o>=9.5) ? 'Elite by any measure' :
    (o>=8.5) ? 'Outstanding; destination dining' :
    (o>=7.5) ? 'Excellent; a clear standout' :
    (o>=6.5) ? 'Good with room to grow' : 'Mixed or below';
}
function mkChips(cat){
  const wrap=document.createElement('div');
  wrap.className='card'; wrap.style.padding='12px'; wrap.style.margin='10px 0';
  wrap.innerHTML=`<div class="grid">
    <div class="g3"><strong>${cat.label}</strong></div>
    <div class="g9 chips" id="chips-${cat.key}"></div>
    <div class="g12 mut" id="help-${cat.key}">${cat.help}</div>
    <div class="g12 mut" id="desc-${cat.key}" style="margin-top:4px"></div>
  </div>`;
  const row=wrap.querySelector('#chips-'+cat.key);
  const descEl=wrap.querySelector('#desc-'+cat.key);
  for(let i=10;i>=0;i--){
    const b=document.createElement('button');
    b.className='chip'; b.textContent=String(i); b.setAttribute('aria-pressed','false');
    b.addEventListener('click',()=>{
      scores[cat.key]=i;
      [...row.children].forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      descEl.textContent = (DESCR[cat.key] && DESCR[cat.key][i]!=null) ? DESCR[cat.key][i] : '';
      updateOverall();
    });
    row.appendChild(b);
  }
  return wrap;
}
function buildCats(){const root=$('cats'); CATS.forEach(c=>root.appendChild(mkChips(c)));}

function rowPayload(){
  return [{
    Timestamp:new Date().toISOString(),
    Date:$('date').value,
    Restaurant:$('restaurant').value.trim(),
    City:$('city').value.trim(),
    Reviewer:$('reviewer').value.trim(),
    Food:n(scores.Food), Service:n(scores.Service), Ambience:n(scores.Ambience),
    Drinks:n(scores.Drinks), Value:n(scores.Value), Consistency:n(scores.Consistency),
    Overall:Number($('overall').textContent),
    Band:$('band').textContent,
    Notes:$('notes').value.trim(),
    UserAgent:navigator.userAgent
  }];
}

/* ===== Debug helpers (shown only with ?debug=1) ===== */
function saveCfg(){ localStorage.setItem(cfgKey, JSON.stringify({
  endpoint:$('endpoint').value.trim(),
  apikey:$('apikey').value.trim()
})); log('Config saved');}
async function testGet(){
  const endpoint = ($('endpoint').value || DEFAULT_ENDPOINT).trim();
  if(!endpoint) return log('Missing endpoint');
  try{ const r=await fetch(endpoint); const t=await r.text(); log({when:'GET',status:r.status,ok:r.ok,response:t.slice(0,600)}); }catch(e){ log({when:'GET',error:String(e)}); }
}
async function postSample(){
  const endpoint = ($('endpoint').value || DEFAULT_ENDPOINT).trim();
  const apikey   = ($('apikey').value   || DEFAULT_APIKEY).trim();
  if(!endpoint) return log('Missing endpoint');
  const headers={'Content-Type':'application/json'}; if(apikey){headers['X-API-KEY']=apikey; headers['Authorization']='Bearer '+apikey;}
  const now=new Date();
  const sample=[{Timestamp:now.toISOString(),Date:now.toISOString().slice(0,10),Restaurant:'Tester Bistro',City:'London',Reviewer:'Chris',Food:9,Service:8,Ambience:8,Drinks:7,Value:7,Consistency:8,Overall:Math.round((9*0.67+8*0.10+8*0.07+7*0.06+7*0.05+8*0.05)*10)/10,Band:'—',Notes:'Smoke test',UserAgent:navigator.userAgent}];
  try{const r=await fetch(endpoint,{method:'POST',headers,body:JSON.stringify(sample)}); log({when:'POST sample',status:r.status,ok:r.ok,response:await r.text()});}catch(e){log({when:'POST sample',error:String(e)});}
}
/* =================================================== */

async function sync(){
  const endpoint = DEBUG ? (($('endpoint').value || DEFAULT_ENDPOINT).trim()) : DEFAULT_ENDPOINT;
  const apikey   = DEBUG ? (($('apikey').value   || DEFAULT_APIKEY).trim())   : DEFAULT_APIKEY;
  if(!endpoint){ alert('Missing endpoint URL'); return; }
  const headers={'Content-Type':'application/json'}; if(apikey){headers['X-API-KEY']=apikey; headers['Authorization']='Bearer '+apikey;}
  try{
    const r=await fetch(endpoint,{method:'POST',headers,body:JSON.stringify(rowPayload())});
    const t=await r.text();
    if(r.ok){ toast('Synced!'); } else { alert('Sync failed: '+r.status); }
    if(DEBUG){ log({when:'POST',status:r.status,ok:r.ok,response:t}); }
  }catch(e){ alert('Network error'); if(DEBUG){ log({when:'POST',error:String(e)}); } }
}

function clearForm(){
  document.querySelectorAll('input[type=text], textarea').forEach(i=>i.value='');
  $('date').value=new Date().toISOString().slice(0,10);
  Object.keys(scores).forEach(k=>delete scores[k]);
  document.querySelectorAll('.chip').forEach(c=>c.setAttribute('aria-pressed','false'));
  document.querySelectorAll('[id^=desc-]').forEach(d=>d.textContent='');
  updateOverall();
}
function saveLocal(){
  const items=JSON.parse(localStorage.getItem('rr_items')||'[]');
  items.push(rowPayload()[0]);
  localStorage.setItem('rr_items', JSON.stringify(items));
  toast('Saved locally ('+items.length+')');
}

/* Init */
$('date').value=new Date().toISOString().slice(0,10);
buildCats(); updateOverall();

/* Show debug UI if requested */
if(DEBUG){
  const cfg=$('configBlock'); if(cfg) cfg.style.display='';
  $('endpoint').value = DEFAULT_ENDPOINT;
  $('apikey').value   = DEFAULT_APIKEY;
  $('saveCfg')?.addEventListener('click', saveCfg);
  $('testBtn')?.addEventListener('click', testGet);
  $('postBtn')?.addEventListener('click', postSample);
}

$('syncBtn').addEventListener('click', sync);
$('clearForm').addEventListener('click', clearForm);
$('saveLocal').addEventListener('click', saveLocal);
</script>
</body>
</html>
