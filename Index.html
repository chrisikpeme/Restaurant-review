<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Restaurant Review – Sheet.best Debug</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;margin:0;background:#0f172a;color:#e5e7eb}
  .wrap{max-width:900px;margin:20px auto;padding:0 14px}
  .card{background:#0b1224;border:1px solid #1f2937;border-radius:14px;padding:18px}
  h1{margin:0 0 10px;font-size:22px}
  label{display:block;margin:6px 0 4px}
  input,textarea,button{font:inherit}
  input,textarea{width:100%;padding:10px;border:1px solid #374151;border-radius:10px;background:#0a1122;color:#e5e7eb}
  textarea{min-height:60px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  button{border:1px solid #374151;background:#0a1122;color:#e5e7eb;padding:10px 14px;border-radius:10px;cursor:pointer}
  pre{white-space:pre-wrap;background:#0a1122;border:1px solid #374151;border-radius:10px;padding:10px;margin-top:10px;overflow:auto}
  .muted{color:#9ca3af}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Restaurant Review — <span class="muted">Sheet.best Debug</span></h1>

    <div class="row">
      <div>
        <label>Restaurant</label><input id="restaurant" placeholder="Test Bistro">
        <label>City</label><input id="city" placeholder="London">
        <label>Reviewer</label><input id="reviewer" placeholder="Chris">
      </div>
      <div>
        <label>Date</label><input id="date" type="date">
        <label>Notes</label><textarea id="notes" placeholder="Smoke test"></textarea>
      </div>
    </div>

    <div class="toolbar">
      <button id="syncBtn">Save + sync to Sheet</button>
      <button id="testBtn">Test endpoint (GET)</button>
      <button id="saveCfg">Save config</button>
    </div>

    <label style="margin-top:10px">Sheet.best Endpoint URL</label>
    <input id="endpoint" placeholder="https://api.sheetbest.com/sheets/...">
    <label>API key (optional)</label>
    <input id="apikey" placeholder="leave blank (Use API = No)">

    <p class="muted" style="margin-top:10px">
      Sheet headers required in row 1: 
      <code>Timestamp, Date, Restaurant, City, Reviewer, Food, Service, Ambience, Drinks, Value, Consistency, Overall, Band, Notes, UserAgent</code>
    </p>

    <label>Debug output</label>
    <pre id="log">—</pre>
  </div>
</div>

<script>
document.getElementById('date').value=new Date().toISOString().slice(0,10);

const cfgKey='sheetbest_cfg_debug_live';
function log(msg){const el=document.getElementById('log');el.textContent=(typeof msg==='string')?msg:JSON.stringify(msg,null,2);}

function saveCfg(){
  localStorage.setItem(cfgKey, JSON.stringify({
    endpoint:document.getElementById('endpoint').value.trim(),
    apikey:document.getElementById('apikey').value.trim()
  }));
  log('Config saved');
}
function loadCfg(){
  try{
    const c=JSON.parse(localStorage.getItem(cfgKey)||'{}');
    document.getElementById('endpoint').value=c.endpoint||'';
    document.getElementById('apikey').value=c.apikey||'';
  }catch(e){}
}
loadCfg();

function gatherRow(){
  return {
    Timestamp: new Date().toISOString(),
    Date: document.getElementById('date').value,
    Restaurant: document.getElementById('restaurant').value.trim(),
    City: document.getElementById('city').value.trim(),
    Reviewer: document.getElementById('reviewer').value.trim(),
    // scores are optional for this debug; main app sends them
    Food:'', Service:'', Ambience:'', Drinks:'', Value:'', Consistency:'',
    Overall:'', Band:'', Notes: document.getElementById('notes').value.trim(),
    UserAgent: navigator.userAgent
  };
}

async function testGet(){
  const {endpoint}=JSON.parse(localStorage.getItem(cfgKey)||'{}');
  if(!endpoint) return log('Missing endpoint');
  try{
    const res=await fetch(endpoint);
    const text=await res.text();
    log({when:'GET', status:res.status, ok:res.ok, response:text.slice(0,500)});
  }catch(e){ log({when:'GET', error:String(e)}); }
}

async function sync(){
  const {endpoint, apikey}=JSON.parse(localStorage.getItem(cfgKey)||'{}');
  if(!endpoint) return log('Missing endpoint');
  const headers={'Content-Type':'application/json'};
  if(apikey){ headers['X-API-KEY']=apikey; headers['Authorization']='Bearer '+apikey; }
  const body=[gatherRow()];
  try{
    const res=await fetch(endpoint,{method:'POST',headers,body:JSON.stringify(body)});
    const text=await res.text();
    log({when:'POST', status:res.status, ok:res.ok, response:text});
  }catch(e){ log({when:'POST', error:String(e)}); }
}

document.getElementById('saveCfg').addEventListener('click',saveCfg);
document.getElementById('testBtn').addEventListener('click',testGet);
document.getElementById('syncBtn').addEventListener('click',sync);
</script>
</body>
</html>
